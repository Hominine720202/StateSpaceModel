カルマンフィルタをスクラッチで実装する。回帰成分モデル。
まずはデータを用意する。
```{r}
n_sample <- 500

set.seed(1)
sig_s <- 1.0
sig_o <- 0.2
beta <- 4.0

level <- cumsum(rnorm(n = n_sample, sd = sig_s))
x <- c(rep(1, 100), rep(3, 150), rep(2, 50), rep(4, 200))

state <- level + beta * x
data <- state + rnorm(n = n_sample, sd = sig_o)

plot(data)
plot(x)
plot(level)
```

```{r}
library(KFAS)

mod <- SSModel(data ~
                 SSMtrend(1, Q = NA) +
                 SSMregression(~ x),
               H = NA)

fit <- fitSSM(mod, inits = numeric(2))
print(fit$model$Q)
print(fit$model$H)

res <- KFS(fit$model)
res

```

```{r}
# parameters
Q <- matrix(c(sig_s, 0, 0, 0), 2, 2)
H <- sig_o

# initiral state
a_1 <- matrix(c(0, 0))
P_1 <- diag(100, 2, 2)

# container of results
a_all <- matrix(nrow = n_sample + 1, ncol = 2)
P_all <- list()

a_i <- a_all[1,] <- a_1
P_i <- P_all[[1]] <- P_1

for (i in 1:n_sample) {
  y_i <- data[i]
  # x included in design matrix
  Z_i <- matrix(c(1, x[i]), 1, 2)
  
  # innovation
  v_i <- y_i - Z_i %*% a_i
  F_i <- Z_i %*% P_i %*% t(Z_i) + H
  # kalman gain
  K_i <- P_i %*% t(Z_i) %*% solve(F_i)

  # filtering estimate
  a_ii <- a_i + K_i %*% v_i
  P_ii <- P_i - K_i %*% F_i %*% t(K_i)
  
  # one-step-ahead prediction
  a_i <- a_ii
  P_i <- P_ii + Q
  a_all[i+1,] <- a_i
  P_all[[i+1]] <- P_i
}
```


```{r}
plot(level)
plot(a_all[,1])
plot(a_all[,2])
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

